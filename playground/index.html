<!-- <script src="https://bundle.run/noble-secp256k1@1.2.14"></script> -->
<script src="https://unpkg.com/@cmdcode/tapscript"></script>
<script src="https://unpkg.com/@cmdcode/crypto-tools"></script>
<script src="esplora.js"></script>
<script src="ripemd.js"></script>
<script src="utils.js"></script>
<script src="u32_state.js"></script>
<script src="u32_std.js"></script>
<script src="u160_std.js"></script>
<script>
    function preprocessJS(text) {
        let code = eval(text)
        if (Array.isArray(code)) {
            code = code.flat(30).join(' ')
        }
        code = code.split('debug;')[0]
        return code
    }

    function codeFormat(code) {
        return (code.replace(/\/\/.*\n|<|>|0x/g, '').split(/\s/).filter(e => e !== ''))
    }

    function intFormat(value) {
        if (!isNaN(value)) {
            value = value.toString(16)
            if (value.length % 2 != 0) {
                value = "0" + value
            }
        }
        return value
    }

    function unlockFormat(unlock_values) {
        const values = unlock_values.replace(/\/\/.*\n|<|>|0x/g, '').split(/\s/).filter(e => e !== '').map(e => isNaN(parseInt(e, 10)) ? e : parseInt(e, 10)).map(e => intFormat(e))
        return values
    }

    function buf2hex(buffer) { // buffer is an ArrayBuffer
        return [...new Uint8Array(buffer)]
            .map(x => x.toString(16).padStart(2, '0'))
            .join('');
    }

</script>
<script type="module">
    import init, {run_script, script_asm_to_hex} from "./bitcoin_scriptexec.js";
    await init();
    const {Tap, Tx, Address, Script, Signer} = tapscript

    const paul = {
        secret: 'd898098e09898a0980989b980809809809f09809884324874302975287524398',
    }
    paul.seckey = crypto_tools.keys.get_seckey(paul.secret)
    // Drop the first byte of the pubkey
    paul.pubkey = buf2hex(crypto_tools.keys.get_pubkey(paul.seckey)).slice(2)

    const vicky = {
        secret: 'a9bd8b8ade888ed12301b21318a3a73429232343587049870132987481723497',
    }
    vicky.seckey = crypto_tools.keys.get_seckey(vicky.secret)
    vicky.pubkey = buf2hex(crypto_tools.keys.get_pubkey(vicky.seckey)).slice(2)
    console.log("vicky.pubkey", vicky.pubkey)

    // Challenge transaction script (1-bit commitment)
    // We only need to check pauls signature because paul doesn't know the preimages.
    const hash_lock_0 = hashLock(vicky.secret, "challenge", 0, 0)
    const hash_lock_1 = hashLock(vicky.secret, "challenge", 0, 1)
    const challenge_script_hex = script_asm_to_hex(['OP_RIPEMD160', 'OP_DUP', hash_lock_0, 'OP_EQUAL', 'OP_SWAP', hash_lock_1, 'OP_EQUAL', 'OP_BOOLOR', 'OP_VERIFY', paul.pubkey, 'OP_CHECKSIG'].join(' '))
    const challenge_script = Script.decode(challenge_script_hex)
    const challenge_tapleaf = Tap.encodeScript(challenge_script)
    const [challenge_tpubkey, challenge_cblock] = Tap.getPubKey(paul.pubkey, {target: challenge_tapleaf})

    // Response transaction script (160bit commitment)
    const u160_script = Script.decode(script_asm_to_hex(preprocessJS(`u160_state("${paul.secret}", "response")`)))
    console.log("u160_script", u160_script)
    const response_script_hex = script_asm_to_hex(vicky.pubkey, 'OP_CHECKSIGVERIFY', [...u160_script, ...Array(160).fill("OP_DROP")].join(' '))
    const response_script = Script.decode(response_script_hex)
    console.log("RESPONSE SCRIPT", response_script)

    const response_tapleaf = Tap.encodeScript(response_script)
    const [response_tpubkey, response_cblock] = Tap.getPubKey(vicky.pubkey, {target: response_tapleaf})

    // Addresses
    const challenge_address = Address.p2tr.fromPubKey(challenge_tpubkey, 'signet')
    console.log("CHALLENGE ADDRESS TO FUND", challenge_address)
    const response_address = Address.p2tr.fromPubKey(response_tpubkey, 'signet')

    const funding_txid = '1e09422df8827d847ad5fb3042c1215cbc493616d85424039318ff854fc55479'

    // Challenge transaction
    const challenge_txdata = Tx.create({
        vin: [{
            // The txid of your funding transaction.
            txid: funding_txid,
            // The index of the output you are spending.
            vout: 1,
            // For Taproot, we need to specify this data when signing.
            prevout: {
                // The value of the output we are spending.
                value: 100_000,
                // This is the script that our taproot address decodes into.
                scriptPubKey: ['OP_1', challenge_tpubkey]
            },
        }],
        vout: [{
            // We are locking up 99_000 sats (minus 1000 sats for fees.)
            value: 99_000,
            // We are locking up funds to this address.
            scriptPubKey: Address.toScriptPubKey(response_address)
        }]
    })

    const challenge_txhex_unsigned = Tx.encode(challenge_txdata).hex
    const challenge_txid = Tx.util.getTxid(challenge_txhex_unsigned)
    console.log('CHALLENGE TXID', challenge_txid)

    // Response transaction
    const response_txdata = Tx.create({
        vin: [{
            // The txid of the previous challenge tx.
            txid: challenge_txid,
            // The index of the output you are spending.
            vout: 0,
            // For Taproot, we need to specify this data when signing.
            prevout: {
                // The value of the output we are spending.
                value: 99_000,
                // This is the script that our taproot address decodes into.
                scriptPubKey: Address.toScriptPubKey(response_address)
            },
        }],
        vout: [{
            value: 90_000,
            // Lock up funds to arbitrary address to not burn them.
            scriptPubKey: Address.toScriptPubKey(challenge_address)
        }]
    })

    const response_txhex_unsigned = Tx.encode(response_txdata).hex
    const response_txid = Tx.util.getTxid(response_txhex_unsigned)
    console.log('RESPONSE TXID', response_txid)

    // Vicky signs Paul's response transaction
    const response_sig = Signer.taproot.sign(vicky.seckey, response_txdata, 0, {extension: response_tapleaf})
    // Paul presigns Vicky's challenge transaction
    const challenge_sig = Signer.taproot.sign(paul.seckey, challenge_txdata, 0, {extension: challenge_tapleaf})

    // Vicky reveals the bit-commitment preimage for value '0' here in the witness.
    console.log("CHALLENGE SCRIPT ASM", Script.fmt.toAsm(challenge_script))
    challenge_txdata.vin[0].witness = [challenge_sig.hex, preimageHex(vicky.secret, "challenge", 0, 0), challenge_script, challenge_cblock]
    console.log(Signer.taproot.verify(challenge_txdata, 0, {pubkey: paul.pubkey}))

    const challenge_txhex = Tx.encode(challenge_txdata).hex

    // Paul reveals the u160 bit-commitment preimages for value '0xdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef'
    const unlock_values = Script.decode(script_asm_to_hex(preprocessJS(`u160_state_unlock("${paul.secret}", "response", "deadbeefdeadbeefdeadbeefdeadbeefdeadbeef")`)))
    console.log("u160 UNLOCK VALUES", unlock_values)
    response_txdata.vin[0].witness = [...unlock_values, response_sig.hex, response_script, response_cblock]
    //console.log(Signer.taproot.verify(response_txdata, 0, {pubkey: vicky.pubkey}))
    const response_txhex = Tx.encode(response_txdata).hex

    window.challenge_txhex = challenge_txhex
    window.response_txhex = response_txhex
    //console.log(challenge_address, response_txdata)
    console.log("CHALLENGE TX HEX", challenge_txhex)
    console.log("RESPONSE TX HEX",  response_txhex)
    //console.log(broadcastTransaction(window.challenge_txhex))
    // console.log(broadcastTransaction(window.response_txhex))
</script>

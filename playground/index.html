<script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
<script src="https://unpkg.com/@cmdcode/tapscript@1.4.1"></script>
<script src="esplora.js"></script>
<script>
const { Tap, Tx, Address, Signer } = tapscript

// Sample secret / public key pair.
const seckey = '730fff80e1413068a05b57d6a58261f07551163369787f349438ea38ca80fac6'
const pubkey = '07b8ae49ac90a048e9b53357a2354b3334e9c8bee813ecb98e99a7e07e8c3ba3'

const scripts = [
    [1, 7, 'OP_ADD', 8, 'OP_EQUALVERIFY', pubkey, 'OP_CHECKSIG'],
    [2, 6, 'OP_ADD', 8, 'OP_EQUALVERIFY', pubkey, 'OP_CHECKSIG'],
    [3, 5, 'OP_ADD', 8, 'OP_EQUALVERIFY', pubkey, 'OP_CHECKSIG'],
    [4, 4, 'OP_ADD', 8, 'OP_EQUALVERIFY', pubkey, 'OP_CHECKSIG'],
    [5, 3, 'OP_ADD', 8, 'OP_EQUALVERIFY', pubkey, 'OP_CHECKSIG'],
    [6, 2, 'OP_ADD', 8, 'OP_EQUALVERIFY', pubkey, 'OP_CHECKSIG'],
    [7, 1, 'OP_ADD', 8, 'OP_EQUALVERIFY', pubkey, 'OP_CHECKSIG']
]

const tree = scripts.map(s => Tap.encodeScript(s))
const script = scripts[0]
const target = Tap.encodeScript(script)

const [tseckey] = Tap.getSecKey(seckey, { tree, target })
const [tpubkey, cblock] = Tap.getPubKey(pubkey, { tree, target })

// A taproot address is simply the tweaked public key, encoded in bech32 format.
const address = Address.p2tr.fromPubKey(tpubkey, 'signet')

const txdata = Tx.create({
    vin: [{
        // The txid of your funding transaction.
        txid: '1766b5f521ca21d23eb6778ad054efb2915df404ec2f513157884886fc33749a',
        // The index of the output you are spending.
        vout: 0,
        // For Taproot, we need to specify this data when signing.
        prevout: {
            // The value of the output we are spending.
            value: 100_000,
            // This is the script that our taproot address decodes into.
            scriptPubKey: Address.toScriptPubKey(address)
        },
    }],
    vout: [{
        // We are locking up 99_000 sats (minus 1000 sats for fees.)
        value: 99_000,
        // We are locking up funds to this address.
        scriptPubKey: Address.toScriptPubKey('tb1pq7u2ujdvjzsy36d4xdt6yd2txv6wnj97aqf7ewvwnxn7ql5v8w3sg98j36')
    }]
})

const txhex_unsigned = Tx.encode( txdata ).hex
const txid = Tx.util.getTxid( txhex_unsigned )
console.log('TXID', txid)

const sig = Signer.taproot.sign(seckey, txdata, 0, { extension: target })
txdata.vin[0].witness = [sig.hex, script, cblock]
const txhex = Tx.encode(txdata).hex

console.log(address, txdata)
console.log(txhex)
// broadcastTransaction(txhex)
</script>
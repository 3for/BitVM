<script type="module">
    import { createActor } from '../transactions/utils.js'
    import { preimageHex } from '../opcodes/u32/u32_state.js'
    import { buildPath } from '../libs/merkle.js'
    
    import { 
        createChallengeResponseChain, 
        presignChallengeResponseChain, 
        executeReveal1bit, 
        executeReveal160bit,
        executeJusticeTx,
    } from '../transactions/reveal-challenge.js'

    import { 
        createMerkleChallenge,
        executeSelectTx,
        executeChallengeTx,
        fundingAddress,
    } from '../transactions/merkle-challenge.js'
   

    const paul = createActor('d898098e09898a0980989b980809809809f09809884324874302975287524398')
    const vicky = createActor('a9bd8b8ade888ed12301b21318a3a73429232343587049870132987481723497')
    
    const funding_outpoint = {
        txid : '6c853b7b19cd35d7ba7561809ab510804864fc4c99f65ac3088c044d91e16034',
        vout : 0,
        value: 100000
    }

    const connect_address = fundingAddress(vicky)
    let { rounds, outpoint } = createChallengeResponseChain(vicky, paul, funding_outpoint, 5, connect_address, 'merkle')


    console.log('Address to fund: ')
    console.log(rounds[0].address)
    console.log('Amount: ', rounds[0].tx.vin[0].prevout.value)
    presignChallengeResponseChain(vicky, paul, rounds)
    
    
    rounds = rounds.concat( createMerkleChallenge(vicky, paul, outpoint) ) 
    rounds.reverse()

    await executeReveal1bit  ( vicky, rounds, 0, 'merkle') // 
    await executeReveal160bit( paul,  rounds, 'deadbeefdeadbeefdeadbeefdeadbeefdeadbeef', 'merkle')
    await executeReveal1bit  ( vicky, rounds, 1, 'merkle')
    await executeReveal160bit( paul,  rounds, 'beefdeadbeefdeadbeefdeadbeefdeadbeefdead', 'merkle')
    await executeReveal1bit  ( vicky, rounds, 0, 'merkle')
    await executeReveal160bit( paul,  rounds, 'beefdeadbeefdeadbeefdeadbeefdeadbeefdead', 'merkle')
    await executeReveal1bit  ( vicky, rounds, 0, 'merkle')
    await executeReveal160bit( paul,  rounds, 'beefdeadbeefdeadbeefdeadbeefdeadbeefdead', 'merkle')
    await executeReveal1bit  ( vicky, rounds, 1, 'merkle')
    await executeReveal160bit( paul,  rounds, 'beefdeadbeefdeadbeefdeadbeefdeadbeefdead', 'merkle')
    

    await executeSelectTx    ( vicky, rounds, 1, 0, 0b01001 )
    await executeChallengeTx ( vicky, paul, rounds, 4, 1, 
        'cea7db5e66bd5868387a438d8512a72cde5f973e',
        '79db24d391abb5c560e26454d29ff3ceb938681e',
        'ebd2c3f8b23391c56c7a5b1725d9466825626a58',
    )

    const preimageA = preimageHex(paul.secret, 'merkle_response_0_5_byte0', 3, 1)
    const preimageB = preimageHex(paul.secret, 'merkle_response_0_5_byte0', 3, 3)
    await executeJusticeTx(vicky, paul, rounds, 0, 0, preimageA, preimageB)

</script>
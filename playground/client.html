<script type="module">
	import * as Esplora  from '../libs/esplora.js'
	import { Tap, Tx, Address, Signer } from '../libs/tapscript.js'
	import { createActor, computeCblock } from '../transactions/utils.js' 
	import { computeTree } from '../transactions/merkle-challenge.js' 

	
	function generateCircuit(outpoint){
		const root = computeTree(paul, [ ['OP_1'] ] )
		console.log(root.address)

		const tx = Tx.create({
	        vin: [{
	            txid: outpoint.txid,
	            vout: outpoint.vout,
	            prevout: {
	                value: outpoint.value,
	                scriptPubKey: Address.toScriptPubKey(root.address)
	            },
	        }],
	        vout: [{
	            value: outpoint.value - 1000, // TODO: fees here
	            scriptPubKey: Address.toScriptPubKey('tb1pq7u2ujdvjzsy36d4xdt6yd2txv6wnj97aqf7ewvwnxn7ql5v8w3sg98j36')
	        }]
	    })

	    const index = 0
		const script = root.scripts[index]
		const cblock = computeCblock(paul, root.tree, index)
		const unlockScript = []
		tx.vin[0].witness = [ ...unlockScript, script, cblock ]
		const txhex = Tx.encode(tx).hex


		const circuit = {}
		circuit[ outpoint.txid ] = txhex

		return circuit
	}

	async function onTransaction(txid){
		console.log(txid)

		const nextTx = circuit[txid]
		if(!nextTx) return

		const prevTx = await Esplora.fetchTransaction(txid)
		console.log(prevTx)

		// Parse script parameters from transaction witness

		await Esplora.broadcastTransaction(nextTx)
		console.log('broadcasted!')
	}


	async function startListening(){
		let prevHeight = await Esplora.fetchLatestBlockHeight() - 3
		console.log(`Started listening at height ${prevHeight}`)
		setInterval( async _ => {
			const latestHeight = await Esplora.fetchLatestBlockHeight()
			while( prevHeight < latestHeight ){
				const blockHash = await Esplora.fetchBlockAtHeight(prevHeight + 1)
				const txids = await Esplora.fetchTXIDsInBlock(blockHash)
				for (const txid of txids) onTransaction(txid)
				prevHeight += 1
			}
		}, 15000)
	}


	const circuit = generateCircuit({
		txid: '02d812bd8077238862bb91ea382a839d1c36aee685a004b1eb3058c652352e40',
		vout: 1,
		value: 100000
	})

	startListening()
</script>